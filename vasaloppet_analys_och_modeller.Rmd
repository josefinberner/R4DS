---
title: "Vasaloppet - Mellantidsrekommendationer"
author: "Olof Rännbäck Garpinger, Knightec AB, olof.rannbackgarpinger@knightec.se"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"Knightec_logo.png\" style=\"float: right;width: 130px;\"/>')
   });
</script>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r libraries, message = F}
library(tidyverse)
library(lubridate)
library(directlabels)
```

```{r functions, message = F}
secs_to_time <- function(x){
  if (!is.na(x)) {
    require(lubridate)
    hh = (x %/% 3600)
    mm = (x %% 3600) %/% 60
    ss = (x %% 3600) %% 60
    hh = ifelse(hh<10, paste0(0,hh), as.character(hh))
    mm = ifelse(mm<10, paste0(0,mm), as.character(mm))
    ss = ifelse(ss<10, paste0(0,ss), as.character(ss))
    y = parse_time(paste0(hh,":",mm,":",ss))
    return(y)
  } else {
    return(NA)
  }
}

avg_paces_and_ranks <- function(tb, year){
  require(tidyverse) 
  tb %>% 
    group_by() %>% 
    summarize(smagan = mean(smagan_pace, na.rm = T),
              mangsbodarna = mean(mangsbodarna_pace, na.rm = T),
              risberg = mean(risberg_pace, na.rm = T),
              evertsberg = mean(evertsberg_pace, na.rm = T),
              oxberg = mean(oxberg_pace, na.rm = T),
              hokberg = mean(hokberg_pace, na.rm = T),
              eldris = mean(eldris_pace, na.rm = T),
              mora = mean(mora_pace, na.rm = T)) %>% 
    mutate(event_year = year) %>% 
    select(event_year, everything()) %>% 
    gather(smagan:mora, key = "checkpoint", value = "pace") %>% 
    filter(!is.na(checkpoint)) %>% 
    mutate(checkpoint_ranks = min_rank(-pace))
}
```


## Förord {#förord}

Denna rapport sammanfattar data från Vasaloppen mellan åren 2012 och 2016. Data har hämtats från den numera nedlagda sajten resultatjakt.se, och innehåller bland annat namn, klubbar, mellantider, och sluttider, på skidåkare som tagit sig i mål. All data som presenteras här har dock anonymiserats för att man inte ska kunna urskilja enskilda personers prestationer. Syftet med rapporten är inte heller att belysa enskilda åkares bedrifter, utan att ta fram statistik och hitta mönster hos större grupper av skidåkare, som t.ex. de med närliggande sluttider.

**Främsta målet med rapporten är att presentera mellantidsrekommendationer givet en önskad övre sluttid.** Det vill säga, att med hjälp av en enkel modell ge skidåkare tidsintervall inom vilka de bör nå kontrollerna i Smågan, Mångsbodarna, Risberg, Evertsberg, Oxberg, Hökberg, och Eldris, om de vill nå Mora innan en viss sluttid. Dessa föreslagna mellantider presenteras i tabeller i kapitel XX. 

Typiska hastighetsprofiler för åkare med närliggande sluttider har också tagits fram, i jämförelse med medelhastigheten för övriga åkare med liknande målgångstider. Utöver detta kommer jag även att försöka besvara bl.a. följande frågor:

* Vilka klubbar (med fler än 40 deltagare) har bäst snittider i respektive lopp? 
* Hur är sluttiderna fördelade från år till år, och från startgrupp till startgrupp?
* Vilka åldersgrupper har störst representation i startfältet? 
* Hur varierar medeltid i mål över åldersgrupperna? Mellan kvinnor och män?
* Kan man hitta några mönster eller avvikelser i skidåkarnas hastighet beroende på år och sluttid?

De olika delarna av rapporten varierar något i svårighetsgrad. De första kapitlen är skrivna för att vem som helst ska kunna läsa dem. Kapitel med mer avancerad analys innehåller *(analys)* i titeln. Kapitel med där matematik på universitetsnivå utnyttjas är markerade med *(avancerat)*. Upplever man texten som för svår eller för lätt får man gärna skicka mig feedbacken. 

Notera att denna rapport inte kan kopplas till Vasaloppsarrangören på något sätt, den är skriven helt på eget bevåg av undertecknad.

#### Vem är jag?

Jag heter Olof Rännbäck-Garpinger och är en sportintresserad skåning, dock helt utan Vasaloppsmeriter. Längdskidor åker jag endast när det finns tillräckligt med snö i södra Sverige, och det händer tyvärr alltför sällan. Min yrkesmässiga bakgrund ligger inom ingenjörsyrket och jag är reglerteknisk specialist. Sedan 2016 brinner jag för Data Science, och denna rapport är en del av mitt lärande inom ämnet. Mina Vasaloppsstudier började först som ett hobbyprojekt, men har sedan övergått till ett mindre projekt på arbetet. 

#### Kod

Rapporten har skrivits i R Markdown där figurer och tabeller har genererats med hjälp av R-kod. R är ett programmeringsspråk som används för t.ex. statistiska analyser, beräkningar, datahantering, visualiseringar, och maskininlärning. All kod som använts för att generera data och figurer kommer att göras tillgänglig framöver i en separat rapport på samma github där denna rapport ligger.

#### English please?

This report explores data from Vasaloppet from 2012 to 2016. It is part of the author's learning project in Data Science. So far, there are no plans to translate the report to English, but this could change if there is enough interest for it. So, if you wish that I translate the report, please send me an e-mail (olof.rannbackgarpinger@knightec.se) with a translation request.

#### Tack!
Jag skulle vilja rikta ett stort tack till Erik Hallengren som har gett mig såväl inspiration till detta arbete, som tillgång till data. 

Jag vill också tacka mina kollegor Josefin Berner, Jonas Dürango, och Pierre Landén för deras feedback på rapporten.

## Innehållsförteckning

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[Förord](#förord)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[1. Vasaloppsdata](#vasaloppsdata)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[2. Mellantider och sluttider från år till år](#tider)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[3. Sammanställning av klubbars medeltider i mål](#klubb)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[4. Medeltider för skidåkare i olika åldersklasser](#ålder)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[5. Mellantidsrekommendationer](#rekommendationer)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[6. Granskning av mellantidsrekommendationerna *(analys)*](#granskning)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[7. Hastigheter för skidåkare med liknande tid i mål *(analys)*](#hastighet)")
```

```{r results="asis",tidy=FALSE,eval=TRUE}
cat("[8. Hastighetsprofiler för skidåkare med liknande tid i mål *(avancerat)*](#profiler)")
```

## 1. Vasaloppsdata {#vasaloppsdata}

Data från samtliga Vasalopp mellan 2012 och 2016 finns lagrade i csv-filer, vilket i princip betyder att den ligger sparad i fem stycken tabeller. En rad i data anger en enskild skidåkares personuppgifter (namn, klubb, startnummer, etc.) och prestation (mellantider och sluttid). Samtliga uppifter som kan peka ut en person har dock anonymiserats i denna rapport då jag endast är intresserad av titta på kollektiva mönster.    

```{r load_data, message = FALSE}
age_levels <- c("19-20","21","35","40","45","50","55","60","65","70","75","80-")
vl_2016 <- read_csv("vl_2016_tidy.csv", 
                    col_types = cols(start_group = col_factor(ordered = T, levels = 0:10),
                                     age_class = col_factor(ordered = T, age_levels),
                                     gender = col_factor(levels = c("M","F")),
                                     time_grp_mora = col_factor(ordered = T, levels = 1:39)
                    ))

vl_2012_x <- read_csv("vl_2012_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2013_x <- read_csv("vl_2013_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2014_x <- read_csv("vl_2014_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2015_x <- read_csv("vl_2015_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vl_2016_x <- read_csv("vl_2016_tidy.csv", 
                    col_types = cols(time_grp_mora = col_factor(ordered = T, levels = 1:39),
                                     event_year = col_factor(ordered = T, levels = 2012:2016)
                    )) %>% 
  select(event_year, club, smagan:mora, time_grp_mora, smagan_pos:mora_pos, smagan_pace:mora_pace)

vasalopp_alla_tider <- vl_2012_x %>% 
  bind_rows(vl_2013_x, vl_2014_x, vl_2015_x, vl_2016_x)

paces_2012 <- avg_paces_and_ranks(vl_2012_x, 2012)
paces_2013 <- avg_paces_and_ranks(vl_2013_x, 2013)
paces_2014 <- avg_paces_and_ranks(vl_2014_x, 2014)
paces_2015 <- avg_paces_and_ranks(vl_2015_x, 2015)
paces_2016 <- avg_paces_and_ranks(vl_2016_x, 2016)

checkpoint_levels <- c("smagan", "mangsbodarna", "risberg", "evertsberg", 
                       "oxberg", "hokberg", "eldris", "mora")

all_avg_paces <- paces_2012 %>% 
  bind_rows(paces_2013, paces_2014, paces_2015, paces_2016) %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels))
```

Samtliga datafiler innehåller tillsammans information om `r nrow(vl_2012_x) + nrow(vl_2013_x) + nrow(vl_2014_x) + nrow(vl_2015_x) + nrow(vl_2016_x)` stycken Vasaloppsbedrifter (där vissa åkare återkommer från år till år). Varje dataset innehåller skidåkar-ID, Vasaloppsår, mellantider och sluttider i sekunder, det vill säga som i tabellen här nedan.

```{r time_data}
set.seed(1)
knitr::kable(vl_2012_x %>% 
               slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>% 
               select(event_year, smagan:mora) %>% 
               mutate(Skidåkare = c(1,2,3,4,5),
                      smagan = smagan+sample(seq(-100, 100, 1),5, replace = T),
                      mangsbodarna = mangsbodarna+sample(seq(-100, 100, 1),5, replace = T),
                      risberg = risberg+sample(seq(-100, 100, 1),5, replace = T),
                      evertsberg = evertsberg+sample(seq(-100, 100, 1),5, replace = T),
                      oxberg = oxberg+sample(seq(-100, 100, 1),5, replace = T),
                      hokberg = hokberg+sample(seq(-100, 100, 1),5, replace = T),
                      eldris = eldris+sample(seq(-100, 100, 1),5, replace = T),
                      mora = mora+sample(seq(-100, 100, 1),5, replace = T)) %>% 
               rename(År = event_year,
                       `Smågan (sek)` = smagan,
                       `Mångsbodarna (sek)` = mangsbodarna,
                       `Risberg (sek)` = risberg,
                       `Evertsberg (sek)` = evertsberg,
                       `Oxberg (sek)` = oxberg,
                       `Hökberg (sek)` = hokberg,
                       `Eldris (sek)` = eldris,
                       `Mora (sek)` = mora) %>% 
               select(Skidåkare, everything()))
```

Om man beräknar tidsdifferensen mellan varje kontroll och lägger till uppgifter om avståndet mellan de olika kontrollerna kan man även få ut skidåkarnas fart mellan varje kontroll. I nästa tabell visas denna information (i km/h). Observera att det inte är samma fem skidåkare som i tabellen ovan. 

```{r paces_data}
set.seed(5)
knitr::kable(vl_2012_x %>% 
  slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>%              
  select(event_year, smagan_pace:mora_pace) %>%
  mutate(Skidåkare = c(6,7,8,9,10),
    smagan_pace = smagan_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      mangsbodarna_pace = mangsbodarna_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      risberg_pace = risberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      evertsberg_pace = evertsberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      oxberg_pace = oxberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      hokberg_pace = hokberg_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      eldris_pace = eldris_pace+sample(seq(-1, 1, 0.01),5, replace = T),
                      mora_pace = mora_pace+sample(seq(-1, 1, 0.01),5, replace = T)) %>%
  rename(År = event_year,
         `Fart till Smågan (km/h)` = smagan_pace,
         `Fart till Mångsbodarna (km/h)` = mangsbodarna_pace,
         `Fart till Risberg (km/h)` = risberg_pace,
         `Fart till Evertsberg (km/h)` = evertsberg_pace,
         `Fart till Oxberg (km/h)` = oxberg_pace,
         `Fart till Hökberg (km/h)` = hokberg_pace,
         `Fart till Eldris (km/h)` = eldris_pace,
         `Fart till Mora (km/h)` = mora_pace) %>% 
  select(Skidåkare, everything())) 
```

Sluttiderna (alltså tiderna i Mora) har även delats in i ett antal tidsgrupper om 15 minuter mellan varje. En grupp är t.ex. den med sluttider mellan 06:45:00 (timmar, minuter, sekunder) och 07:00:00. Denna grupp kommer jag fortsättningvis kalla gruppen som är i mål innan 07:00:00. Denna konvention kommer således användas i mellantidsrekommenderingen i kapitel XX. 

I data från 2016 finns även uppgifter om genus (Man/Kvinna), åldersgrupp (12 grupper: 19-20, 21, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80-), och startgrupp (11 grupper från 0-10, där 0 är högst rankat och 10 är lägst rankat). Om jag tolkat åldersgrupperna korrekt så innehåller t.ex. grupp 21 alla åkare mellan 21 och 34 år, och så vidare. 

```{r 2016_specific_data}
set.seed(9)
knitr::kable(vl_2016 %>% 
  slice(sample(seq(1,dim(vl_2012_x)[1],1),5)) %>%
  select(event_year, gender, age_class, start_group) %>% 
  mutate(Skidåkare = c(1,2,3,4,5),
         gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  rename(År = event_year,
         Genus = gender,
         Åldersklass = age_class,
         Startgrupp = start_group) %>% 
  select(Skidåkare, everything()))
```

Dessa uppgifter används nedan för att göra en lite mer utförlig analys av 2016 års data. Dessutom kan man beräkna hur mycket snabbare eller långsammare en skidåkare har åkt relativt övriga åkare i samma startgrupp. D.v.s. avgöra hur väl de har åkt jämfört med andra åkare som har liknande ambitionsnivå. Denna information kommer användas i kapitel XX för att analysera mönster i skidåkarnas hastighetsprofiler.

## 2. Mellantider och sluttider från år till år {#tider}

Tabellen nedan innehåller uppgifter om medeltider vid varje kontroll och mål (i Mora) har varierat från år till år. Notera att endast skidåkare som tagit sig i mål funnits med i dessa uträkningar.

```{r avg_times_year}
median_times_all_years <- vasalopp_alla_tider %>% 
  group_by(event_year) %>% 
  summarize(`Smågan (sek)` = secs_to_time(median(smagan, na.rm = T)),
            `Mångsbodarna (sek)` = secs_to_time(median(mangsbodarna, na.rm = T)),
            `Risberg (sek)` = secs_to_time(median(risberg, na.rm = T)),
            `Evertsberg (sek)` = secs_to_time(median(evertsberg, na.rm = T)),
            `Oxberg (sek)` = secs_to_time(median(oxberg, na.rm = T)),
            `Hökberg (sek)` = secs_to_time(median(hokberg, na.rm = T)),
            `Eldris (sek)` = secs_to_time(median(eldris, na.rm = T)),
            `Mora (sek)` = secs_to_time(median(mora, na.rm = T))) %>% 
  rename(År = event_year)

# Tabell
knitr::kable(median_times_all_years)
```

2012 års Vasalopp var således snabbast av de fem, faktiskt ända från Smågan till mål. Vasaloppet 2015 var långsammast och det verkar främst ha berott på förhållandena efter Mångsbodarna. 

Figuren nedan visar hur många skidåkare som varje år gått i mål inom 15-minutersintervall. Här ser vi t.ex. hur det 2012 var ovanligt många skidåkare med tider mellan 5 och 8 timmar. 2015 var det å andra sidan väldigt få som gick i mål innan 5-timmarsstrecket. En annan intressant detalj är att 2016 års fördelning har en rejäl topp strax innan 10 timmar. Frågan är vad det kan har berott på? Låt oss återkomma till detta längre fram i rapporten.

```{r skiiers_mora_15_min_intervals_all_years}
vasalopp_alla_tider %>% 
  mutate(mora = secs_to_time(mora)) %>% 
  ggplot(aes(mora, col = event_year)) +
  geom_freqpoly(binwidth = 900, lwd = 1.5) +
  labs(x = "Tid i mål",
       y = "Antal skidåkare som går i mål inom 15-minutersintervall") +
  scale_color_discrete("År")
```

Nästa figur visar antalet skidåkare inom varje startgrupp som kommit i mål inom 15-minutersintervall under 2016 års Vasalopp. Lägre startgrupper är mer välsamlade än de högre, vilket tyder på en mer samlad ambitionsnivå hos de åkarna. Grupperna 8-10 har alla samma tydliga spik innan 10 timmar, som även syntes i föregående figur. Startgrupp 10 har för övrigt den klart största spridningen i sluttider, och man märker att många av skidlöparna i denna grupp egentligen borde ha tillhört en något lägre startgrupp. Gissningsvis de som inte ville eller hade möjlighet att få en bättre seedning.  

```{r skiiers_mora_15_min_intervals_all_start_groups_2016}
vl_2016 %>% 
  filter(!is.na(start_group)) %>% 
  mutate(mora = secs_to_time(mora)) %>% 
  ggplot(aes(mora,col = start_group)) + 
  geom_freqpoly(binwidth = 600, lwd = 1.5) +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Tid i mål",
       y = "Antal skidåkare som går i mål inom 15-minutersintervall") +
  scale_color_discrete("Startgrupp")
```


## 3. Sammanställning av klubbars medeltider i mål {#klubb}

Data innehåller samtliga skidåkares klubbtillhörighet, och jag har därför valt att beräkna medeltider i mål för samtliga klubbar med fler än 40 deltagare i de enskilda loppen. Att gränsen dragits vid just 40 deltagare beror på att jag velat begränsa antalet klubbar i de fem figurerna nedan, som visar medeltiderna för varje klubb. I figurerna kan man se att klubbar från södra Sverige (som t.ex. Lugi SK, och IFK Helsingborg) och klubbar med företagsnamn (som Volvo IF, IBM-klubben, etc.) typiskt har lite sämre medeltider i mål. Exempel på prominenta klubbar är Borås SK, Östersunds skidlöpareklubb, IKJ Haninge, Sundbybergs IK, Karlslunds IF SF, och IFK Mora SK. Över lag är det många storstadsklubbar representerade, vilket inte är så oväntat.

```{r clubs_2012}
# Medeltid i Mora för klubbar med fler än 50 åkare
vl_2012_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2012") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2013}
vl_2013_x %>% 
  mutate(club = as.factor(club)) %>% 
  filter((club != "Norge") & (club != "Norway")) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2013") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2014}
vl_2014_x %>% 
  filter((club != "Norge") & (club != "Norway") & (club != "Germany")) %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2014") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

```{r clubs_2015}
vl_2015_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2015") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:32:00")))
```

```{r clubs_2016}
vl_2016_x %>% 
  mutate(club = as.factor(club)) %>% 
  group_by(club) %>% 
  filter(!is.na(club)) %>% 
  summarize(avg_mora = secs_to_time(mean(mora)),
            count = n()) %>% 
  filter(count > 40) %>% 
  ggplot(aes(avg_mora, fct_reorder(club, -avg_mora))) +
  geom_point() +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Medeltid i mål",
       y = "Klubbar med fler än 40 skidåkare") +
  scale_x_time(breaks=parse_time(c("06:00:00","06:30:00","07:00:00","07:30:00",
                                   "08:00:00","08:30:00","09:00:00","09:30:00")),
               limits=parse_time(c("06:00:00","09:30:00")))
```

## 4. Medeltider för skidåkare i olika åldersklasser {#ålder}

Låt oss nu ta en titt på hur åldersfördelningen såg ut bland de som tog sig i mål i Vasaloppet 2016. Figuren nedan visar antalet skidlöpare i varje klass per antalet år i åldersklassen. Anledningen till denna indelningen är att vissa åldersklasser spänner över många år (som *21*), och vissa över klart färre (som *19-20*). Detta är säkert främsta anledningen till det stora hoppet i antal mellan *19-20*-klassen och *21*-klassen. Intressant nog kan man notera att det är flest deltagare i åldern 40-44 år. Är detta månne ett tecken på 40-årskris? :-)

```{r ageclasses_histogram_2016}
vl_2016 %>% 
  filter(!is.na(age_class)) %>% 
  count(age_class) %>% 
  mutate(n = ifelse(age_class == 21, n/14, n/5)) %>% 
  mutate(n = ifelse(age_class == "19-20", n*5/2, n)) %>% 
  ggplot(aes(age_class, n)) +
  geom_bar(stat = "identity") +
  labs(x = "Åldersklass",
       y = "Antal skidåkare i varje klass per antal år i klass")
```

I nästa figur är åldersgrupperna även uppdelade mellan män och kvinnor. Dels kan man se att det är klart färre kvinnor som ställt upp, samt att de är mer jämnt fördelade över åldrarna 21 till 54 år.  

```{r ageclasses_gender_histogram_2016}
vl_2016 %>% 
  mutate(gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  filter(!is.na(age_class)) %>% 
  group_by(age_class, gender) %>% 
  count(age_class) %>% 
  mutate(n = ifelse(age_class == 21, n/14, n/5)) %>% 
  mutate(n = ifelse(age_class == "19-20", n*5/2, n)) %>% 
  ggplot(aes(age_class, n, group = gender, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Åldersklass",
       y = "Antal skidåkare i varje klass per antal år i klass") +
  scale_fill_discrete("Genus")
```

Om man sammanställer medeltiderna för respektive åldersgrupp kan man också se att *40*-gruppen inte bara är den mest välrepresenterade gruppen, utan även har den bästa medeltiden av alla. Det känns hoppingivande för en 37-åring att skidåkare mellan 40 och 44 år har de bästa snittiderna. För övrigt kan man notera att det är först efter 60 som åldern på allvar verkar börja sätta begränsningar för hur snabbt man åker.

```{r ageclasses_avgmoratime_2016}
vl_2016 %>% 
  group_by(age_class) %>% 
  summarize(avg_mora = mean(mora), count = n()) %>% 
  na.omit() %>% 
  mutate(avg_mora = secs_to_time(avg_mora)) %>% 
  ggplot(aes(age_class, avg_mora, group = 1)) +
  geom_line(lwd = 1.5) +
  scale_y_time(breaks=parse_time(c("07:30:00","08:00:00","08:30:00","09:00:00","09:30:00","10:00:00"))) +
  labs(x = "Åldersklass",
       y = "Medeltid i mål")
```

I nästa figur är medeltiderna även uppdelade efter kön. I snitt låg kvinnorna kring 1 timme och 40 minuter efter männen i samma åldersklasser. 

```{r ageclasses_gender_avgmoratime_2016}
vl_2016 %>% 
  mutate(gender = fct_recode(gender,
                             "Man" = "M",
                             "Kvinna" = "F")) %>% 
  group_by(gender, age_class) %>% 
  summarize(avg_mora = mean(mora),
            count = n()) %>%
  mutate(avg_mora = secs_to_time(avg_mora)) %>% 
  na.omit() %>% 
  ggplot(aes(age_class, avg_mora)) +
  geom_line(aes(group = gender, col = gender), lwd = 1.5) +
  scale_y_time(breaks=parse_time(c("07:30:00","08:00:00","08:30:00","09:00:00","09:30:00","10:00:00", "10:30:00")),
               limits = parse_time(c("07:27:00","10:30:00"))) +
  labs(x = "Åldersklass",
       y = "Medeltid i mål") +
  scale_color_discrete("Genus") 
```

Generellt sett ska man dock passa sig för att dra alltför långtgående slutsatser endast utifrån ett års Vasalopp (eller fem för den delen). Det kan finnas variationer mellan åren som man inte information om. 

## 5. Mellantidsrekommendationer {#rekommendationer}
```{r mora_grp_time}
mora_seqs <- seq(12600,47700,15*60)
jj <- 1
mora_grp_time <- vector(mode = "character",length(7:31))
for (ii in mora_seqs[7:31]) {
  mora_grp_time[jj] <- as.character(secs_to_time(ii))
  jj <- jj+1
}
mora_grp_time <- parse_time(mora_grp_time)
```

```{r timerec_noanalysis, include = FALSE}
vasalopp_alla_tider_mod <- vasalopp_alla_tider
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "smagan"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "mangsbodarna"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2015, "risberg"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2016, "oxberg"] = NA
vasalopp_alla_tider_mod[vasalopp_alla_tider_mod$event_year == 2016, "hokberg"] = NA

time_recommender <- vasalopp_alla_tider_mod %>%
  group_by(time_grp_mora) %>%
  summarize(smagan_1 = secs_to_time(quantile(smagan, 0.125, na.rm = T)),
            smagan_2 = secs_to_time(median(smagan, na.rm = T)),
            smagan_3 = secs_to_time(quantile(smagan, 0.875, na.rm = T)),
            mangsbodarna_1 = secs_to_time(quantile(mangsbodarna, 0.125, na.rm = T)),
            mangsbodarna_2 = secs_to_time(median(mangsbodarna, na.rm = T)),
            mangsbodarna_3 = secs_to_time(quantile(mangsbodarna, 0.875, na.rm = T)),
            risberg_1 = secs_to_time(quantile(risberg, 0.125, na.rm = T)),
            risberg_2 = secs_to_time(median(risberg, na.rm = T)),
            risberg_3 = secs_to_time(quantile(risberg, 0.875, na.rm = T)),
            evertsberg_1 = secs_to_time(quantile(evertsberg, 0.125, na.rm = T)),
            evertsberg_2 = secs_to_time(median(evertsberg, na.rm = T)),
            evertsberg_3 = secs_to_time(quantile(evertsberg, 0.875, na.rm = T)),
            oxberg_1 = secs_to_time(quantile(oxberg, 0.125, na.rm = T)),
            oxberg_2 = secs_to_time(median(oxberg, na.rm = T)),
            oxberg_3 = secs_to_time(quantile(oxberg, 0.875, na.rm = T)),
            hokberg_1 = secs_to_time(quantile(hokberg, 0.125, na.rm = T)),
            hokberg_2 = secs_to_time(median(hokberg, na.rm = T)),
            hokberg_3 = secs_to_time(quantile(hokberg, 0.875, na.rm = T)),
            eldris_1 = secs_to_time(quantile(eldris, 0.125, na.rm = T)),
            eldris_2 = secs_to_time(median(eldris, na.rm = T)),
            eldris_3 = secs_to_time(quantile(eldris, 0.875, na.rm = T))) %>% 
  filter(between(as.numeric(time_grp_mora),7, 31))

for(ii in 1:length(mora_grp_time)) {
  tmp <- time_recommender %>% 
    select(-time_grp_mora) %>% 
    slice(ii)
  name <- paste0("table_", mora_grp_time[ii])
  assign(name, tibble(Kontroll = c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg",
                                   "Oxberg", "Hökberg", "Eldris"),
                      "Undre tid"=c(tmp[[1]],tmp[[4]],tmp[[7]],tmp[[10]],tmp[[13]],tmp[[16]],tmp[[19]]),
                      "Rekommenderad tid"=c(tmp[[2]],tmp[[5]],tmp[[8]],tmp[[11]],tmp[[14]],tmp[[17]],tmp[[20]]),
                      "Övre tid"=c(tmp[[3]],tmp[[6]],tmp[[9]],tmp[[12]],tmp[[15]],tmp[[18]],tmp[[21]])) %>% 
           mutate(Tidsfönster = secs_to_time(as.integer(`Övre tid`-`Undre tid`))))
}
```

I detta kapitel ges rekommendationer på lämpliga mellantider givet en viss önskad tid i mål. Rekommendationstabellerna nedan kan även användas för att givet en viss mellantid hitta en mer lämplig sluttid. På så vis kan man undvika att ta ut sig i onödan för en kanske orealistisk sluttid. 

I tabellerna anges övre gräns för sluttiden ovanför tabellen. Antag t.ex. att det står *I mål innan 07:00:00*. Då gäller tabellen skidåkare som önskar ta sig i mål mellan 06:45:00 och 07:00:00. Första kolonnen i tabellen anger vilken kontroll det rör sig om. *Rekommenderad tid* anger den tid då skidåkaren rekommenderas ankomma till kontrollen. Denna har härletts genom att ta mediantiden för ett antal skidåkare med liknande tid i mål. *Undre tid* och *Övre tid* har valts så att de rymmer ungefär 75% av alla skidlöpares tider (av de som har samma sluttid). 

Sluttiderna i tabellerna nedan sträcker sig mellan 05:00:00 och 11:00:00. Dessa gränser har valts därför att det är någorlunda många åkare (över de här fem åren) som har tagit sig i mål mellan dessa tider. Övriga sluttider är helt enkelt inte lika välrepresenterade i data. 

Om man vill kan man rita ut undre och övre tider tillsammans med de rekommenderade tiderna, mot sluttiderna. Då får man figuren här nedan. Rekommenderade tiderna ges av heldragna linjer, undre och övre tider av streckade linjer.

```{r time_recommender_interval_plot}
time_recommender %>% 
  ggplot(aes(y = mora_grp_time, x = smagan_2)) +
  geom_line(aes(col = "1. Smågan"), lwd = 1.5) +
  geom_line(aes(x = smagan_1, col = "1. Smågan"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = smagan_3, col = "1. Smågan"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_2, col = "2. Mångsbodarna"), lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_1, col = "2. Mångsbodarna"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = mangsbodarna_3, col = "2. Mångsbodarna"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = risberg_2, col = "3. Risberg"), lwd = 1.5) +
  geom_line(aes(x = risberg_1, col = "3. Risberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = risberg_3, col = "3. Risberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = evertsberg_2, col = "4. Evertsberg"), lwd = 1.5) +
  geom_line(aes(x = evertsberg_1, col = "4. Evertsberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = evertsberg_3, col = "4. Evertsberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = oxberg_2, col = "5. Oxberg"), lwd = 1.5) +
  geom_line(aes(x = oxberg_1, col = "5. Oxberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = oxberg_3, col = "5. Oxberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = hokberg_2, col = "6. Hökberg"), lwd = 1.5) +
  geom_line(aes(x = hokberg_1, col = "6. Hökberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = hokberg_3, col = "6. Hökberg"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = eldris_2, col = "7. Eldris"), lwd = 1.5) +
  geom_line(aes(x = eldris_1, col = "7. Eldris"),lty = 2, lwd = 1.5) +
  geom_line(aes(x = eldris_3, col = "7. Eldris"),lty = 2, lwd = 1.5) + 
  scale_color_discrete(name="") +
  xlab("Tid vid kontroll") +
  ylab("Tid i mål") + 
  theme(legend.position = "top")
```

Mellantidsrekommendationerna härleds och granskas för övrigt i nästa kapitel. Där ser man bland annat att det kan variera en del mellan åren vilka tider skidlöparna kommer in, trots att de få samma sluttider. Det är således inte hela världen ifall man missar något eller några tidsintervall. Faktum är att fler än 60% missar åtminstone ett intervall. Granskningen visar även att ungefär 75% av skidlöparna med en viss sluttid prickar in åtminstone fyra av sju tidsintervall. Missar man fler än så kan man fråga sig själv ifall man verkligen har disponerat sitt lopp på bästa sätt. Mer om detta i sista kapitlet.

**Notera att rekommendationstabellerna är härledda för riktiga Vasaloppet. De har inte testats på data från t.ex. öppet spår.**

#### I mål innan *05:00:00*
```{r 0500}
knitr::kable(
  `table_05:00:00`
)
```

#### I mål innan *05:15:00*
```{r 0515}
knitr::kable(
  `table_05:15:00`
)
```

#### I mål innan *05:30:00*
```{r 0530}
knitr::kable(
  `table_05:30:00`
)
```

#### I mål innan *05:45:00*
```{r 0545}
knitr::kable(
  `table_05:45:00`
)
```

#### I mål innan *06:00:00*
```{r 0600}
knitr::kable(
  `table_06:00:00`
)
```

#### I mål innan *06:15:00*
```{r 0615}
knitr::kable(
  `table_06:15:00`
)
```

#### I mål innan *06:30:00*
```{r 0630}
knitr::kable(
  `table_06:30:00`
)
```

#### I mål innan *06:45:00*
```{r 0645}
knitr::kable(
  `table_06:45:00`
)
```

#### I mål innan *07:00:00*
```{r 0700}
knitr::kable(
  `table_07:00:00`
)
```

#### I mål innan *07:15:00*
```{r 0715}
knitr::kable(
  `table_07:15:00`
)
```

#### I mål innan *07:30:00*
```{r 0730}
knitr::kable(
  `table_07:30:00`
)
```

#### I mål innan *07:45:00*
```{r 0745}
knitr::kable(
  `table_07:45:00`
)
```

#### I mål innan *08:00:00*
```{r 0800}
knitr::kable(
  `table_08:00:00`
)
```

#### I mål innan *08:15:00*
```{r 0815}
knitr::kable(
  `table_08:15:00`
)
```

#### I mål innan *08:30:00*
```{r 0830}
knitr::kable(
  `table_08:30:00`
)
```

#### I mål innan *08:45:00*
```{r 0845}
knitr::kable(
  `table_08:45:00`
)
```

#### I mål innan *09:00:00*
```{r 0900}
knitr::kable(
  `table_09:00:00`
)
```

#### I mål innan *09:15:00*
```{r 0915}
knitr::kable(
  `table_09:15:00`
)
```

#### I mål innan *09:30:00*
```{r 0930}
knitr::kable(
  `table_09:30:00`
)
```

#### I mål innan *09:45:00*
```{r 0945}
knitr::kable(
  `table_09:45:00`
)
```

#### I mål innan *10:00:00*
```{r 1000}
knitr::kable(
  `table_10:00:00`
)
```

#### I mål innan *10:15:00*
```{r 1015}
knitr::kable(
  `table_10:15:00`
)
```

#### I mål innan *10:30:00*
```{r 1030}
knitr::kable(
  `table_10:30:00`
)
```

#### I mål innan *10:45:00*
```{r 1045}
knitr::kable(
  `table_10:45:00`
)
```

#### I mål innan *11:00:00*
```{r 1100}
knitr::kable(
  `table_11:00:00`
)
```

## 6. Granskning av mellantidsrekommendationerna *(analys)* {#granskning}

```{r train_test_data_split}
set.seed(2)
train <- sample(1:dim(vasalopp_alla_tider)[1],round(dim(vasalopp_alla_tider)[1]*0.8))
vl_train_tmp <- vasalopp_alla_tider[train,]
vl_test_tmp <- vasalopp_alla_tider[-train,]

vl_train <- vl_train_tmp %>% 
  filter(between(as.numeric(time_grp_mora), 7, 31)) # Mora groups with more than 100 skiiers every year
vl_test <- vl_test_tmp %>% 
  filter(between(as.numeric(time_grp_mora), 7, 31)) # Mora groups with more than 100 skiiers every year
```

```{r quantile_median_time_summary_all_controls}
summerade_tider_train_all_tmp <- vl_train %>%
  group_by(time_grp_mora,event_year) %>%
  summarize(median_smagan = secs_to_time(median(smagan, na.rm = T)),
            lowQ_smagan = secs_to_time(quantile(smagan, 0.125, na.rm = T)),
            highQ_smagan = secs_to_time(quantile(smagan, 0.875, na.rm = T)),
            median_mangsbodarna = secs_to_time(median(mangsbodarna, na.rm = T)),
            lowQ_mangsbodarna = secs_to_time(quantile(mangsbodarna, 0.125, na.rm = T)),
            highQ_mangsbodarna = secs_to_time(quantile(mangsbodarna, 0.875, na.rm = T)),
            median_risberg = secs_to_time(median(risberg, na.rm = T)),
            lowQ_risberg = secs_to_time(quantile(risberg, 0.125, na.rm = T)),
            highQ_risberg = secs_to_time(quantile(risberg, 0.875, na.rm = T)),
            median_evertsberg = secs_to_time(median(evertsberg, na.rm = T)),
            lowQ_evertsberg = secs_to_time(quantile(evertsberg, 0.125, na.rm = T)),
            highQ_evertsberg = secs_to_time(quantile(evertsberg, 0.875, na.rm = T)),
            median_oxberg = secs_to_time(median(oxberg, na.rm = T)),
            lowQ_oxberg = secs_to_time(quantile(oxberg, 0.125, na.rm = T)),
            highQ_oxberg = secs_to_time(quantile(oxberg, 0.875, na.rm = T)),
            median_hokberg = secs_to_time(median(hokberg, na.rm = T)),
            lowQ_hokberg = secs_to_time(quantile(hokberg, 0.125, na.rm = T)),
            highQ_hokberg = secs_to_time(quantile(hokberg, 0.875, na.rm = T)),
            median_eldris = secs_to_time(median(eldris, na.rm = T)),
            lowQ_eldris = secs_to_time(quantile(eldris, 0.125, na.rm = T)),
            highQ_eldris = secs_to_time(quantile(eldris, 0.875, na.rm = T)),
            median_mora = secs_to_time(median(mora, na.rm = T)),
            lowQ_mora = secs_to_time(quantile(mora, 0.125, na.rm = T)),
            highQ_mora = secs_to_time(quantile(mora, 0.875, na.rm = T)),
            n())

summerade_tider_train_all <- tibble(time_grp_mora = as.ordered(7:31),
       mora_grp_time) %>% 
  inner_join(summerade_tider_train_all_tmp, by = "time_grp_mora")
```

```{r plot_quantile_median_time_summary_smagan_vs_mora}
summerade_tider_train_all %>%
  ggplot(aes(y = mora_grp_time, x = median_smagan, group = event_year, col = as.ordered(event_year))) +
  geom_line(lwd = 1.5) +
  geom_line(aes(x = lowQ_smagan),lty = 2, lwd = 1.5) +
  geom_line(aes(x = highQ_smagan),lty = 2, lwd = 1.5) +
  labs(x = "Tid i Smågan",
       y = "Tid i mål") +
  scale_color_discrete("År") +
  theme(legend.position = "top")
```

```{r plot_quantile_median_time_summary_hokberg_vs_mora}
summerade_tider_train_all %>%
  ggplot(aes(y = mora_grp_time, x = median_hokberg, group = event_year, col = as.ordered(event_year))) +
  geom_line(lwd = 1.5) +
  geom_line(aes(x = lowQ_hokberg),lty = 2, lwd = 1.5) +
  geom_line(aes(x = highQ_hokberg),lty = 2, lwd = 1.5) +
  labs(x = "Tid i Hökberg",
       y = "Tid i mål") +
  scale_color_discrete("År") +
  theme(legend.position = "top")
```

```{r remove_unrepresentive_train_data}
vl_train_mod <- vl_train
vl_train_mod[vl_train_mod$event_year == 2015, "smagan"] = NA
vl_train_mod[vl_train_mod$event_year == 2015, "mangsbodarna"] = NA
vl_train_mod[vl_train_mod$event_year == 2015, "risberg"] = NA
vl_train_mod[vl_train_mod$event_year == 2016, "oxberg"] = NA
vl_train_mod[vl_train_mod$event_year == 2016, "hokberg"] = NA
```

```{r time_summary_modified_train_data}
summerade_tider <- vl_train_mod %>% 
  group_by(time_grp_mora) %>% 
  summarize(median_smagan = median(smagan, na.rm = T),
            lowQ_smagan = quantile(smagan, 0.125, na.rm = T),
            highQ_smagan = quantile(smagan, 0.875, na.rm = T),
            median_mangsbodarna = median(mangsbodarna, na.rm = T),
            lowQ_mangsbodarna = quantile(mangsbodarna, 0.125, na.rm = T),
            highQ_mangsbodarna = quantile(mangsbodarna, 0.875, na.rm = T),
            median_risberg = median(risberg, na.rm = T),
            lowQ_risberg = quantile(risberg, 0.125, na.rm = T),
            highQ_risberg = quantile(risberg, 0.875, na.rm = T),
            median_evertsberg = median(evertsberg, na.rm = T),
            lowQ_evertsberg = quantile(evertsberg, 0.125, na.rm = T),
            highQ_evertsberg = quantile(evertsberg, 0.875, na.rm = T),
            median_oxberg = median(oxberg, na.rm = T),
            lowQ_oxberg = quantile(oxberg, 0.125, na.rm = T),
            highQ_oxberg = quantile(oxberg, 0.875, na.rm = T),
            median_hokberg = median(hokberg, na.rm = T),
            lowQ_hokberg = quantile(hokberg, 0.125, na.rm = T),
            highQ_hokberg = quantile(hokberg, 0.875, na.rm = T),
            median_eldris = median(eldris, na.rm = T),
            lowQ_eldris = quantile(eldris, 0.125, na.rm = T),
            highQ_eldris = quantile(eldris, 0.875, na.rm = T),
            median_mora = median(mora, na.rm = T),
            lowQ_mora = quantile(mora, 0.125, na.rm = T),
            highQ_mora = quantile(mora, 0.875, na.rm = T),
            n())
```

```{r count_number_of_intervals_test_set_falls_into}
vl_time_rec_check_tmp <- vl_test %>% 
  select(event_year, time_grp_mora, smagan:mora) %>% 
  inner_join(summerade_tider, by = "time_grp_mora") %>% 
  na.omit() %>% 
  mutate(smagan_check = as.integer(ifelse((smagan < highQ_smagan) & (smagan > lowQ_smagan), 1, 0)),
         mangsbodarna_check = as.integer(ifelse((mangsbodarna < highQ_mangsbodarna) & (mangsbodarna > lowQ_mangsbodarna), 1, 0)),
         risberg_check = as.integer(ifelse((risberg < highQ_risberg) & (risberg > lowQ_risberg), 1, 0)),
         evertsberg_check = as.integer(ifelse((evertsberg < highQ_evertsberg) & (evertsberg > lowQ_evertsberg), 1, 0)),
         oxberg_check = as.integer(ifelse((oxberg < highQ_oxberg) & (oxberg > lowQ_oxberg), 1, 0)),
         hokberg_check = as.integer(ifelse((hokberg < highQ_hokberg) & (hokberg > lowQ_hokberg), 1, 0)),
         eldris_check = as.integer(ifelse((eldris < highQ_eldris) & (eldris > lowQ_eldris), 1, 0))) %>% 
  select(event_year, time_grp_mora, smagan_check:eldris_check) 

checked <- vl_time_rec_check_tmp %>% 
  select(smagan_check:eldris_check) %>% 
  as.matrix() %>% 
  rowSums() %>% 
  paste0("/7") %>% 
  as.ordered()

vl_time_rec_check <- vl_time_rec_check_tmp %>% 
  mutate(checked = checked) %>% 
  select(event_year, time_grp_mora, checked, everything())
```

```{r plot_skiier_number_of_intervals_checked}
vl_time_rec_check %>% 
  count(checked) %>% 
  mutate(proportion = 100*n/sum(n)) %>% 
  mutate(proportion_acc = cumsum(proportion)) %>%
  mutate(proportion = round(proportion,1),
         proportion_acc = round(proportion_acc,1)) %>% 
  ggplot(aes(x = checked, y = proportion, fill = checked)) +
  geom_bar(stat = "identity") +
  labs(x = "Proportion av inprickade tidsintervall",
       y = "Andel skidåkare i testdata (%)") +
  ylim(0,40) +
  scale_fill_discrete(guide=FALSE)
```

```{r skiiers_deviation_from_75percent_intervals_all_years}
checkpoint_levels2 <- c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg", "Oxberg", "Hökberg", "Eldris")
vl_time_rec_check %>%
  group_by(event_year) %>% 
  summarize(smagan = -(75-round(100*mean(smagan_check),1)),
            mangsbodarna = -(75-round(100*mean(mangsbodarna_check),1)),
            risberg = -(75-round(100*mean(risberg_check),1)),
            evertsberg = -(75-round(100*mean(evertsberg_check),1)),
            oxberg = -(75-round(100*mean(oxberg_check),1)),
            hokberg = -(75-round(100*mean(hokberg_check),1)),
            eldris = -(75-round(100*mean(eldris_check),1))) %>% 
  mutate(Smågan = smagan,
         Mångsbodarna = mangsbodarna,
         Risberg = risberg,
         Evertsberg = evertsberg,
         Oxberg = oxberg,
         Hökberg = hokberg,
         Eldris = eldris) %>% 
  select(-(smagan:eldris)) %>% 
  gather(Smågan:Eldris, key = "checkpoint", value = "accuracy") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels2)) %>% 
  ggplot(aes(event_year, accuracy)) +
  geom_bar(aes(fill = event_year), stat = "identity") +
  facet_wrap(~checkpoint, nrow = 2) +
  scale_fill_discrete(guide=FALSE) +
  labs(x = "År",
       y = "Avvikelse från 75 procents intervalluppfyllnad (%)")
```

```{r skiiers_deviation_from_75percent_intervals_all_moratimegrps}
tibble(time_grp_mora = as.ordered(7:31),
       mora_grp_time) %>% inner_join(vl_time_rec_check, by = "time_grp_mora") %>% 
  group_by(mora_grp_time) %>% 
  summarize(smagan = -(75-round(100*mean(smagan_check),1)),
            mangsbodarna = -(75-round(100*mean(mangsbodarna_check),1)),
            risberg = -(75-round(100*mean(risberg_check),1)),
            evertsberg = -(75-round(100*mean(evertsberg_check),1)),
            oxberg = -(75-round(100*mean(oxberg_check),1)),
            hokberg = -(75-round(100*mean(hokberg_check),1)),
            eldris = -(75-round(100*mean(eldris_check),1))) %>% 
  mutate(Smågan = smagan,
         Mångsbodarna = mangsbodarna,
         Risberg = risberg,
         Evertsberg = evertsberg,
         Oxberg = oxberg,
         Hökberg = hokberg,
         Eldris = eldris) %>% 
  select(-(smagan:eldris)) %>% 
  gather(Smågan:Eldris, key = "checkpoint", value = "accuracy") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels2)) %>% 
  ggplot(aes(mora_grp_time, accuracy)) + 
  geom_bar(aes(fill = checkpoint), stat = "identity") +
  facet_wrap(~checkpoint, nrow = 2) +
  scale_fill_discrete(guide=FALSE) +
  coord_flip() +
  labs(x = "Tid i Mora",
       y = "Avvikelse från 75 procents intervalluppfyllnad (%)")
```

```{r skiiers_deviation_from_75percent_intervals_all_years_all_moratimegrps}
vl_time_rec_check %>%
  group_by(event_year, time_grp_mora) %>%
  summarize(smagan = -(75-round(100*mean(smagan_check),1)),
            mangsbodarna = -(75-round(100*mean(mangsbodarna_check),1)),
            risberg = -(75-round(100*mean(risberg_check),1)),
            evertsberg = -(75-round(100*mean(evertsberg_check),1)),
            oxberg = -(75-round(100*mean(oxberg_check),1)),
            hokberg = -(75-round(100*mean(hokberg_check),1)),
            eldris = -(75-round(100*mean(eldris_check),1))) %>%
  mutate(Smågan = smagan,
         Mångsbodarna = mangsbodarna,
         Risberg = risberg,
         Evertsberg = evertsberg,
         Oxberg = oxberg,
         Hökberg = hokberg,
         Eldris = eldris) %>% 
  select(-(smagan:eldris)) %>% 
  gather(Smågan:Eldris, key = "checkpoint", value = "accuracy") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels2)) %>% 
  ggplot(aes(event_year, accuracy)) +
  geom_jitter(aes(col = event_year), width = 0.2, height = 0, alpha = 0.5) +
  facet_wrap(~checkpoint, nrow = 2) +
  scale_color_discrete(guide=FALSE) +
  labs(x = "År",
       y = "Avvikelse från 75 procents intervalluppfyllnad (%)")
```

## 7. Hastigheter för skidåkare med liknande tid i mål *(analys)*{#hastighet}

I detta kapitel kommer vi titta lite mer på hur hastigheterna har varierat från år till år på de olika delsträckorna. Tabellen sammanställer medelfarten (i km/h) för samtliga delsträckor. De snabbaste sträckorna sett till alla år är: Smågan-Mångsbodarna, Mångsbodarna-Risberg, och Evertsberg-Oxberg. Klart långsammaste sträckan är Start till Smågan, men det är inte så konstigt med tanke på den köbildning som uppstår där när tusentals åkare trängs om ett fåtal spår.

```{r avg_paces_all_controls_all_years}
mean_paces_years <- vasalopp_alla_tider %>% 
  group_by(event_year) %>% 
  summarize(`Fart till Smågan (km/h)` = round(mean(smagan_pace, na.rm = T),1),
            `Fart till Mångsbodarna (km/h)` = round(mean(mangsbodarna_pace, na.rm = T),1),
            `Fart till Risberg (km/h)` = round(mean(risberg_pace, na.rm = T),1),
            `Fart till Evertsberg (km/h)` = round(mean(evertsberg_pace, na.rm = T),1),
            `Fart till Oxberg (km/h)` = round(mean(oxberg_pace, na.rm = T),1),
            `Fart till Hökberg (km/h)` = round(mean(hokberg_pace, na.rm = T),1),
            `Fart till Eldris (km/h)` = round(mean(eldris_pace, na.rm = T),1),
            `Fart till Mora (km/h)` = round(mean(mora_pace, na.rm = T),1)) %>% 
  rename(År = event_year)

knitr::kable(mean_paces_years)
```

```{r mora_grp_time2, message = F}
mora_seqs <- seq(12600,47700,15*60)
jj <- 1
mora_grp_time2 <- vector(mode = "character",length(3:35))
for (ii in mora_seqs[3:35]) {
  mora_grp_time2[jj] <- as.character(secs_to_time(ii))
  jj <- jj+1
}
mora_grp_time2 <- parse_time(mora_grp_time2)
```

```{r avgpaces_all_timegrpsmora_all_controls_all_years_creating_tibbles}
paces_2012_startgrupper <- vl_2012_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2012) %>% 
  select(event_year, everything())

paces_2013_startgrupper <- vl_2013_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2013) %>% 
  select(event_year, everything()) 

paces_2014_startgrupper <- vl_2014_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2014) %>% 
  select(event_year, everything()) 

paces_2015_startgrupper <- vl_2015_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2015) %>% 
  select(event_year, everything()) 

paces_2016_startgrupper <- vl_2016_x %>% 
  filter(time_grp_mora < 36) %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2)) %>% 
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora") %>% 
  mutate(event_year = 2016) %>% 
  select(event_year, everything())
```

I resterande figurer i detta kapitel kommer vi att titta på medelhastigheter för skidåkare med liknande tider i mål (se kapitel 1 för förklaring till hur åkarna delades in i tidsgrupper). Första bilden visar hur medelhastigheten berodde av sluttiden under 2012 års Vasalopp. Dels kan man se att hastigheten mellan start och Smågan avtar snabbare än övriga kurvor med hänsyn till sluttid. Det antyder att det bara är de allra bästa åkarna som knappt påverkas av köbildningen vid start. En annan intressant tendens är den att hastigheterna avtog så markant mellan Mångsbodarna och Risberg för åkare med sluttid mellan 9 och 11 timmar. Min första gissning var att hastighetssänkningen kunde ha med följande vurpor att göra: <https://www.youtube.com/watch?v=LohiNobXNs0>. Men en mer insatt källa har berättat att denna backe kommer först efter Risberg, och skulle därmed inte ha kunnat påverka hastigheterna.

```{r avg_time_timegrpsmora_all_controls_2012}
paces_2012_startgrupper %>% 
  ggplot(aes(mora_grp_time2,smagan_pace_mean)) +
  geom_line(aes(col="1. Smågan"),lwd = 1.5) +
  geom_line(aes(y = mangsbodarna_pace_mean, col="2. Mångsbodarna"),lwd = 1.5) +
  geom_line(aes(y = risberg_pace_mean, col="3. Risberg"),lwd = 1.5) +
  geom_line(aes(y = evertsberg_pace_mean, col="4. Evertsberg"),lwd = 1.5) +
  geom_line(aes(y = oxberg_pace_mean, col="5. Oxberg"),lwd = 1.5) +
  geom_line(aes(y = hokberg_pace_mean, col="6. Hökberg"),lwd = 1.5) +
  geom_line(aes(y = eldris_pace_mean, col="7. Eldris"),lwd = 1.5) +
  geom_line(aes(y = mora_pace_mean, col="8. Mora"),lwd = 1.5) +
  scale_color_discrete("Kontroll") +
  ggtitle("Vasaloppet 2012") +
  labs(x = "Tid i Mora",
       y = "Medelfart (km/h) till kontroll")
```

Nästa figur visar samma hastighetskurvor för 2016. Intressant nog har skidåkare med sluttid strax innan 10 timmar högre fart från Hökberg till Mora än vad åkare med sluttid strax därinnan hade. Skulle det kunna vara så att 10-timmarsstrecket är så hägrande att många skidlöpare tar ut sig lite extra bara för att nå detta?

```{r avg_time_timegrpsmora_all_controls_2016}
paces_2016_startgrupper %>% 
  ggplot(aes(mora_grp_time2,smagan_pace_mean)) +
  geom_line(aes(col="1. Smågan"),lwd = 1.5) +
  geom_line(aes(y = mangsbodarna_pace_mean, col="2. Mångsbodarna"),lwd = 1.5) +
  geom_line(aes(y = risberg_pace_mean, col="3. Risberg"),lwd = 1.5) +
  geom_line(aes(y = evertsberg_pace_mean, col="4. Evertsberg"),lwd = 1.5) +
  geom_line(aes(y = oxberg_pace_mean, col="5. Oxberg"),lwd = 1.5) +
  geom_line(aes(y = hokberg_pace_mean, col="6. Hökberg"),lwd = 1.5) +
  geom_line(aes(y = eldris_pace_mean, col="7. Eldris"),lwd = 1.5) +
  geom_line(aes(y = mora_pace_mean, col="8. Mora"),lwd = 1.5) +
  scale_color_discrete("Kontroll") +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Tid i Mora",
       y = "Medelfart (km/h) till kontroll")
```

Låt oss slutligen undersöka ifall några av mönstren från föregående två figurer återkommer mer än ett år. Följande två figurer visar således hur medelfarten har varierat över samtliga år, för sträckorna Mångsbodarna-Risberg och Eldris-Mora. I den första figuren kan vi se att hastighetssänkningen till Risberg endast förekom 2012. I den andra figuren ser vi tendenser till fartökningar för åkare som går i mål kring 10 timmar, även i 2014 och 2015 års lopp. Dessa är dock inte lika tydliga som den 2016. 

En annan intressant observation är att 2016 års kurva ligger klart under de övriga mellan Mångsbodarna och Risberg, men sedan över de övriga mellan Eldris och Mora. Det antyder att de kunde köra ikapp förlorad tid under slutet av det loppet.

```{r avgpaces_mangsbodarna_to_risberg_all_years}
checkpoint_levels3 <- c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg", "Oxberg", "Hökberg", "Eldris", "Mora")
paces_2012_startgrupper %>% 
  bind_rows(paces_2013_startgrupper, paces_2014_startgrupper, 
            paces_2015_startgrupper, paces_2016_startgrupper) %>% 
  rename(Smågan = smagan_pace_mean,
         Mångsbodarna = mangsbodarna_pace_mean,
         Risberg = risberg_pace_mean,
         Evertsberg = evertsberg_pace_mean,
         Oxberg = oxberg_pace_mean,
         Hökberg = hokberg_pace_mean,
         Eldris = eldris_pace_mean,
         Mora = mora_pace_mean) %>% 
  mutate(event_year = as.ordered(event_year)) %>% 
  gather(Smågan:Mora, key = "checkpoint", value = "mean_pace") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels3)) %>% 
  filter((checkpoint == "Risberg")) %>% 
  ggplot(aes(mora_grp_time2, mean_pace, group = event_year, col = event_year)) +
  geom_line(lwd = 1.2) +
  scale_color_discrete("År") +
  labs(x = "Tid i mål",
       y = "Medelfart (km/h)") +
  ggtitle("Medelfarter mellan Mångsbodarna och Risberg") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
```

```{r avgpaces_eldris_to_mora_all_years}
paces_2012_startgrupper %>% 
  bind_rows(paces_2013_startgrupper, paces_2014_startgrupper, 
            paces_2015_startgrupper, paces_2016_startgrupper) %>% 
  rename(Smågan = smagan_pace_mean,
         Mångsbodarna = mangsbodarna_pace_mean,
         Risberg = risberg_pace_mean,
         Evertsberg = evertsberg_pace_mean,
         Oxberg = oxberg_pace_mean,
         Hökberg = hokberg_pace_mean,
         Eldris = eldris_pace_mean,
         Mora = mora_pace_mean) %>% 
  mutate(event_year = as.ordered(event_year)) %>% 
  gather(Smågan:Mora, key = "checkpoint", value = "mean_pace") %>% 
  mutate(checkpoint = factor(checkpoint, levels = checkpoint_levels3)) %>% 
  filter((checkpoint == "Mora")) %>% 
  ggplot(aes(mora_grp_time2, mean_pace, group = event_year, col = event_year)) +
  geom_line(lwd = 1.2) +
  scale_color_discrete("År") +
  labs(x = "Tid i mål",
       y = "Medelfart (km/h)") +
  ggtitle("Medelfarter mellan Eldris och Mora") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))
```

```{r moratime_vs_all_controltimes_all_skiiers_all_years}
p <- vasalopp_alla_tider %>% 
  mutate(smagan = secs_to_time(smagan),
         mangsbodarna = secs_to_time(mangsbodarna),
         risberg = secs_to_time(risberg),
         evertsberg = secs_to_time(evertsberg),
         oxberg = secs_to_time(oxberg),
         hokberg = secs_to_time(hokberg),
         eldris = secs_to_time(eldris),
         mora = secs_to_time(mora)) %>% 
  ggplot(aes(y = mora)) + 
  geom_point(aes(smagan, col = "1. Smågan"),alpha = 0.15) + 
  geom_point(aes(mangsbodarna, col = "2. Mångsbodarna"),alpha = 0.15) + 
  geom_point(aes(risberg, col = "3. Risberg"),alpha = 0.15) + 
  geom_point(aes(evertsberg, col = "4. Evertsberg"),alpha = 0.15) +
  geom_point(aes(oxberg, col = "5. Oxberg"),alpha = 0.15) + 
  geom_point(aes(hokberg, col = "6. Hökberg"),alpha = 0.15) +
  geom_point(aes(eldris, col = "7. Eldris"),alpha = 0.15)
p + 
  scale_color_discrete(name="Kontroll") +
  xlab("Tid vid kontroll") +
  ylab("Tid i mål")
```

```{r moratime_vs_all_controltimes_all_skiiers_2015_2016}
vasalopp_alla_tider %>% 
  filter((event_year==2015)|(event_year==2016)) %>% 
  mutate(smagan = secs_to_time(smagan),
         mangsbodarna = secs_to_time(mangsbodarna),
         risberg = secs_to_time(risberg),
         evertsberg = secs_to_time(evertsberg),
         oxberg = secs_to_time(oxberg),
         hokberg = secs_to_time(hokberg),
         eldris = secs_to_time(eldris),
         mora = secs_to_time(mora)) %>% 
  ggplot(aes(col = as.ordered(event_year))) + 
  geom_point(aes(smagan,mora),alpha = 0.04) + 
  geom_point(aes(mangsbodarna,mora),alpha = 0.04) + 
  geom_point(aes(risberg,mora),alpha = 0.04) + 
  geom_point(aes(evertsberg,mora),alpha = 0.04) +
  geom_point(aes(oxberg,mora),alpha = 0.04) + 
  geom_point(aes(hokberg,mora),alpha = 0.04) +
  geom_point(aes(eldris,mora),alpha = 0.04) + 
  scale_color_discrete(name="År") +
  xlab("Tid vid kontroll") +
  ylab("Tid i mål")
```
Kan alltså skilja ganska mycket från år till år vilka tider som skidåkarna kommit in till de olika kontrollerna. De skuggade områdena visar hur mycket av data som överlappar. Så exempelvis Mångsbodarna till Oxberg är det ganska stor andel data som inte överlappar. Detta beror säkert på att olika sträckor är olika svåråkta från år till år. 

```{r mean_paces_sumary_all_years_all_moratimegrps}
summerade_hastigheter <- vasalopp_alla_tider %>% 
  group_by(event_year, time_grp_mora) %>% 
  summarize(smagan = mean(smagan_pace, na.rm = T),
            mangsbodarna = mean(mangsbodarna_pace, na.rm = T),
            risberg = mean(risberg_pace, na.rm = T),
            evertsberg = mean(evertsberg_pace, na.rm = T),
            oxberg = mean(oxberg_pace, na.rm = T),
            hokberg = mean(hokberg_pace, na.rm = T),
            eldris = mean(eldris_pace, na.rm = T),
            mora = mean(mora_pace, na.rm = T)
  ) %>% 
  mutate(Smågan = smagan,
         Mångsbodarna = mangsbodarna,
         Risberg = risberg,
         Evertsberg = evertsberg,
         Oxberg = oxberg,
         Hökberg = hokberg,
         Eldris = eldris,
         Mora = mora) %>% 
  select(-(smagan:eldris)) %>% 
  gather(Smågan:Mora, key = "checkpoint", value = "pace") %>% 
  mutate(checkpoint = factor(checkpoint, 
                             levels = c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg",
                                        "Oxberg", "Hökberg", "Eldris", "Mora"))) %>% 
  filter(between(as.numeric(time_grp_mora), 3, 36)) %>%
  inner_join(tibble(time_grp_mora = as.ordered(3:35), mora_grp_time2), by = "time_grp_mora")
```

```{r moratimegrps_pane_plot_yearly_paces_compared_to_mean_all_years_2015}
summerade_hastigheter %>%
  filter(event_year==2015) %>% 
  inner_join(summerade_hastigheter %>% 
               group_by(checkpoint, mora_grp_time2) %>% 
               summarize(mean_pace = mean(pace)), by = c("mora_grp_time2","checkpoint")) %>% 
  mutate(mora_grp_time2 = as.ordered(as.character(mora_grp_time2))) %>% 
  ggplot(aes(checkpoint, pace-mean_pace, group = event_year, fill = event_year)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ mora_grp_time2, nrow = 4) +
  guides(fill=FALSE) +
  coord_flip() +
  labs(x = "Kontroll",
       y = "Medelhastighet år - Medelhastighet alla år mellan 2012 och 2016 (km/h)") +
  scale_y_continuous(breaks = c(-1,0,1), labels = c(-1,0,1)) +
  ggtitle("Vasaloppet 2015")
```

```{r moratimegrps_pane_plot_yearly_paces_compared_to_mean_all_years_2016}
summerade_hastigheter %>%
  filter(event_year==2016) %>% 
  inner_join(summerade_hastigheter %>% 
               group_by(checkpoint, mora_grp_time2) %>% 
               summarize(mean_pace = mean(pace)), by = c("mora_grp_time2","checkpoint")) %>% 
  mutate(mora_grp_time2 = as.ordered(as.character(mora_grp_time2))) %>% 
  ggplot(aes(checkpoint, pace-mean_pace, group = event_year, fill = event_year)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ mora_grp_time2, nrow = 4) +
  guides(fill=FALSE) +
  coord_flip() +
  labs(x = "Kontroll",
       y = "Medelhastighet år - Medelhastighet alla år mellan 2012 och 2016 (km/h)") +
  ggtitle("Vasaloppet 2016")
```

Under 2015 års Vasalopp var det många med liknande sluttider som körde relativt långsamt i början av loppet, men relativt fort i mellan Evertsberg och Eldris. År 2016 körde man istället relativt snabbat i början och sen långsammare mot slutet. (Tänkbara förklaringar skulle kunna vara snöfall och/eller spår som håller olika väl.)

## 8. Hastighetsprofiler för skidåkare med liknande tid i mål *(avancerat)*{#profiler}

```{r normalize_time_and_add_performance_measure}
mora_time_grp_pace_summary <- vl_2016 %>% 
  group_by(time_grp_mora) %>% 
  summarize(smagan_pace_mean = round(mean(smagan_pace,na.rm=T),2),
            mangsbodarna_pace_mean = round(mean(mangsbodarna_pace,na.rm=T),2),
            risberg_pace_mean = round(mean(risberg_pace,na.rm=T),2),
            evertsberg_pace_mean = round(mean(evertsberg_pace,na.rm=T),2),
            oxberg_pace_mean = round(mean(oxberg_pace,na.rm=T),2),
            hokberg_pace_mean = round(mean(hokberg_pace,na.rm=T),2),
            eldris_pace_mean = round(mean(eldris_pace,na.rm=T),2),
            mora_pace_mean = round(mean(mora_pace,na.rm=T),2))

vl_2016_tmp <- vl_2016 %>% 
  filter(!is.na(start_group)) %>% 
  group_by(start_group) %>% 
  summarize(start_grp_mora_mean = mean(mora, na.rm = T)) %>% 
  left_join(vl_2016, by = "start_group")


vl_2016_with_performance_measures <- vl_2016_tmp %>% 
  inner_join(mora_time_grp_pace_summary, by = "time_grp_mora") %>%
  mutate(smagan_npace = smagan_pace-smagan_pace_mean,
         mangsbodarna_npace = mangsbodarna_pace-mangsbodarna_pace_mean,
         risberg_npace = risberg_pace-risberg_pace_mean,
         evertsberg_npace = evertsberg_pace-evertsberg_pace_mean,
         oxberg_npace = oxberg_pace-oxberg_pace_mean,
         hokberg_npace = hokberg_pace-hokberg_pace_mean,
         eldris_npace = eldris_pace-eldris_pace_mean,
         mora_npace = mora_pace-mora_pace_mean) %>% 
  select(event_year:start_group,everything(),
         -(smagan_pace:mora_pace),
         -(smagan_pace_mean:mora_pace_mean)) %>% 
  mutate(mora_start_grp_normalized = round(start_grp_mora_mean - mora)) %>% 
  select(-start_grp_mora_mean)
```

```{r vl_2016_pca}
pca_tmp <- vl_2016_with_performance_measures %>% 
  select(start_nbr, smagan_npace:mora_npace) %>% 
  na.omit()

pca_test <- pca_tmp %>% 
  select(smagan_npace:mora_npace)

vl_2016_pca <- vl_2016_with_performance_measures %>% 
  left_join(pca_tmp %>%
              select(start_nbr) %>% 
              mutate(PC1 = prcomp(pca_test, scale = T)$x[,1],
                     PC2 = prcomp(pca_test, scale = T)$x[,2],
                     PC3 = prcomp(pca_test, scale = T)$x[,3]),
            by = "start_nbr")
```

```{r pca_example_plot1}
vl_2016_pca_example <- vl_2016_pca %>% 
  select(smagan_npace, hokberg_npace) %>% 
  na.omit()

pr.out <- prcomp(vl_2016_pca_example , scale = T)

direction1 <- tibble(x = 2.3*c(0,-pr.out$rotation[1,1]),
                     y = 2.3*c(0,-pr.out$rotation[1,2]))
direction2 <- tibble(x = 1.3*c(0,pr.out$rotation[2,1]),
                     y = 1.3*c(0,pr.out$rotation[2,2]))

vl_2016_pca_example %>% 
  mutate(smagan_npace = scale(smagan_npace),
         hokberg_npace = scale(hokberg_npace)) %>% 
  ggplot(aes(smagan_npace, hokberg_npace)) +
  geom_point() +
  geom_line(data = direction1, aes(x,y, col = "Principalkomponent 1"), arrow = arrow(length=unit(0.30,"cm"), ends="first", type = "closed"),lwd = 1.2) +
  geom_line(data = direction2, aes(x,y, col = "Principalkomponent 2"), arrow = arrow(length=unit(0.30,"cm"), ends="first", type = "closed"),lwd = 1.2) +
  coord_fixed() +
  xlim(-6,6) +
  ylim(-6,6) +
  scale_color_discrete("") +
  labs(x = "Normaliserad fart mellan start och Smågan",
       y = "Normaliserad fart mellan Oxberg och Hökberg")
```

```{r pca_example_plot2}
temp <- as.tibble(pr.out$x)
temp %>% 
  ggplot(aes(-PC1, PC2)) +
  geom_point() +
  xlim(-6,6) +
  ylim(-6,6) +
  coord_fixed() +
  labs(x="Värde i principalkomponent 1",
       y="Värde i principalkomponent 2")
```

```{r plot_PC1_comp_vs_time_gain_2016}
vl_2016_pca %>% 
  ggplot(aes(PC1,mora_start_grp_normalized)) +
  geom_point() +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Värde i principalkomponent 1",
       y = "Tid i mål jämfört med medeltid i mål för samma startgrupp (sekunder)")
```

```{r plot_PC2_comp_vs_time_gain_2016}
vl_2016_pca %>% 
  ggplot(aes(PC2,mora_start_grp_normalized)) +
  geom_point() +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Värde i principalkomponent 2",
       y = "Tid i mål jämfört med medeltid i mål för samma startgrupp (sekunder)")
```

```{r plot_PC3_comp_vs_time_gain_2016}
vl_2016_pca %>% 
  ggplot(aes(PC3,mora_start_grp_normalized)) +
  geom_point() +
  ggtitle("Vasaloppet 2016") +
  labs(x = "Värde i principalkomponent 3",
       y = "Tid i mål jämfört med medeltid i mål för samma startgrupp (sekunder)")
```

```{r time_gain_vs_PC1_PC2_hyperplane_model_matrix_2016}
vl.lm <- lm(mora_start_grp_normalized ~ PC1 + PC2, vl_2016_pca)
x <- seq(-3.5,3.5,0.2)
y <- seq(-3.5,3.5,0.2)
X <- vector(mode = "double", length(x)*length(y))
Y <- vector(mode = "double", length(x)*length(y))
z <- vector(mode = "double", length(x)*length(y))
kk <- 1
for (ii in 1:length(x)) {
  for (jj in 1:length(y)) {
    vl_grid <- tibble(PC1 = x[ii],
                      PC2 = y[jj])
    X[kk] = x[ii]
    Y[kk] = y[jj]
    z[kk] <- predict(vl.lm, vl_grid)
    kk <- kk+1
  }
}
hyperplane <- tibble(X, Y, z)
w <- vl.lm$coefficients[2:3]/norm(as.matrix(vl.lm$coefficients[2:3]),type = "F")
MG_arrow <- tibble(x = c(-w[1]*5,w[1]*5), y = c(-w[2]*5,w[2]*5))
```

```{r model_contour_plot_over_PC1_PC2_components_2016}
v <- vl_2016_pca %>% 
  ggplot(aes(PC1, PC2)) +
  geom_point(col = "grey45", pch = 1) +
  coord_fixed() +
  xlim(-5,5) +
  ylim(-5,5) +
  ggtitle("Vasaloppet 2016") +
  stat_contour(data = hyperplane, aes(X,Y,z = z, col = ..level..), lwd = 1.2) +
  geom_line(data = MG_arrow, aes(x,y), arrow = arrow(length=unit(0.30,"cm"), 
                                                     ends="first", type = "closed"),lwd = 1.2) +
  labs(x="Värde i principalkomponent 1",
       y="Värde i principalkomponent 2")
direct.label(v, list("bottom.pieces", cex = 1.34))
```

```{r plot_PC1_PC2_loadings_and_preferred_pace_profile_2016}
pr.out <- prcomp(pca_test, scale = T)
checkpoint_levels <- c("Smågan", "Mångsbodarna", "Risberg", "Evertsberg", 
                        "Oxberg", "Hökberg", "Eldris", "Mora")
as.tibble(pr.out$rotation) %>% 
  mutate(representative_pace = w[1]*PC1+w[2]*PC2,
         checkpoint = factor(checkpoint_levels, levels = checkpoint_levels)) %>% 
  select(checkpoint, PC1, PC2, representative_pace) %>% 
  ggplot(aes(checkpoint, PC1, group = 1)) +
  geom_line(aes(col = "Principalkomponent 1"), lwd = 1.2) +
  geom_line(aes(y = PC2, col = "Principalkomponent 2"), lwd = 1.2) +
  geom_line(aes(y = representative_pace, col = "Fördelaktig fartprofil för\nskidåkare med liknande tider i Mora"), lwd = 1.2) +
  scale_color_discrete("Fartprofiler") +
  xlab("Kontroll") +
  ylab("Normaliserad fart mellan kontroller") +
  ggtitle("Vasaloppet 2016") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```

```{r plot_principal_loadings_2016}
vl_2015 <- read_csv("vl_2015_npaces_and_performance.csv", 
                    col_types = cols(gender = col_factor(levels = c("M","F")),
                                     time_grp_mora = col_factor(ordered = T, levels = 1:39)
                    ))

pca_tmp <- vl_2015 %>% 
  select(start_nbr, smagan_npace:mora_npace) %>% 
  na.omit()

pca_test <- pca_tmp %>% 
  select(smagan_npace:mora_npace)

vl_2015_pca <- vl_2015 %>% 
  left_join(pca_tmp %>%
              select(start_nbr) %>% 
              mutate(PC1 = prcomp(pca_test, scale = T)$x[,1],
                     PC2 = prcomp(pca_test, scale = T)$x[,2],
                     PC3 = prcomp(pca_test, scale = T)$x[,3]),
            by = "start_nbr")

pr.out <- prcomp(pca_test, scale = T)
as.tibble(pr.out$rotation) %>% 
  mutate(checkpoint = factor(checkpoint_levels, levels = checkpoint_levels)) %>% 
  select(checkpoint, PC1, PC2) %>% 
  ggplot(aes(checkpoint, PC1, group = 1)) +
  geom_line(aes(col = "Principalkomponent 1"), lwd = 1.2) +
  geom_line(aes(y = -PC2, col = "Principalkomponent 2"), lwd = 1.2) +
  scale_color_discrete("Fartprofiler") +
  xlab("Kontroll") +
  ylab("Normaliserad fart mellan kontroller") +
  ggtitle("Vasaloppet 2015") +
  theme(axis.text.x = element_text(angle = 50, hjust = 1))
```















